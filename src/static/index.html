<!DOCTYPE html>
<html class="dark" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>UFD Agent</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <!-- HTMX scripts -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/htmx.org/dist/ext/ws.js"></script>
  <!-- <script> htmx.logAll() </script> -->
  <script>
    function finalizeAndClear(event) {
      const form = event.target;

      const promptInput = form.querySelector('input[name="prompt"]');
      const reasoningCheckbox = document.querySelector('input[name="show_reasoning"]');
      const iterationsInput = document.querySelector('input[name="max_iterations"]').value;
      const fileInput = form.querySelector('input[name="files"]');
      const uploadFilesContainer = document.getElementById('uploaded-files-container');

      console.log('--- SUCCESS: htmx:wsConfigSend Fired. Clearing Form. ---');

      const promptValue = promptInput ? promptInput.value : '';

      let showReasoning = reasoningCheckbox ? (reasoningCheckbox.checked ? 'true' : 'false') : 'false';

      let maxIterations = iterationsInput ? iterationsInput.value : '';

      const uploadedFiles = uploadFilesContainer.querySelectorAll('input[name="uploaded_file_paths"]');
      const filePaths = Array.from(uploadedFiles).map(input => input.value);

      // The data that htmx is about to send is in event.detail.parameters
      // We override this with the complex data structure we need
      event.detail.parameters = {
        prompt: promptValue,
        show_reasoning: showReasoning,
        max_iterations: maxIterations,
        uploaded_file_paths: filePaths
      };

      if (promptInput) {
        promptInput.value = '';
        promptInput.focus();
      }
      if (fileInput) {
        fileInput.value = '';
      }
      if (uploadedFilesContainer) {
        uploadedFilesContainer.innerHTML = '';
        uploadedFilesContainer.style.display = 'none';
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      const chatForm = document.getElementById('chat-form');
      if (chatForm) {
        // This event allows modification of the payload AND execution of commands
        chatForm.addEventListener('htmx:wsConfigSend', finalizeAndClear);
        console.log('Payload/Clear listener attached.');
      }
    });

  </script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#003366",
            "secondary": "#008080",
            "accent": "#FF7F50",
            "background-light": "#F5F5F5",
            "background-dark": "#101c22",
          },
          fontFamily: {
            "display": ["Manrope", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.25rem",
            "lg": "0.5rem",
            "xl": "0.75rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }

    .toggle-checkbox:checked+.toggle-label .toggle-dot {
      transform: translateX(100%);
    }

    .toggle-checkbox:checked+.toggle-label {
      background-color: #008080;
    }

    .line-clamp-3 {
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
    }
  </style>
  <style>
    #progress-bar {
      width: 100%;
      background: #eee;
      height: 24px;
      border-radius: 4px;
      overflow: hidden;
    }

    #progress-bar>div {
      height: 100%;
      background: #3b82f6;
      width: 0%;
      color: white;
      text-align: center;
      line-height: 24px;
      transition: width 0.2s;
    }
  </style>
  <script>
    function addShowMore(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;

      // Check if the content is overflowing
      const isOverflowing = container.scrollHeight > container.clientHeight;

      if (isOverflowing && !container.querySelector('.show-more-btn')) {
        container.classList.add('line-clamp-3');

        const button = document.createElement('button');
        button.textContent = 'Show More ⬇️';
        button.className = 'show-more-btn text-sm text-blue-400 hover:text-blue-300 font-semibold transition-colors duration-150 mt-2';

        button.onclick = () => {
          container.classList.toggle('line-clamp-3');
          if (container.classList.contains('line-clamp-3')) {
            button.textContent = 'Show More ⬇️';
          } else {
            button.textContent = 'Show Less ⬆️';
          }
        };

        // Insert the button right after the container div
        container.parentNode.insertBefore(button, container.nextSibling);
      }
    }
  </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
  <div class="flex h-screen w-full">
    <aside
      class="flex flex-col w-64 bg-background-light dark:bg-gray-900/50 border-r border-gray-200 dark:border-gray-700">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <button
          class="w-full flex items-center justify-center gap-2 rounded-lg bg-primary text-white h-10 px-4 text-sm font-bold">
          <span class="material-symbols-outlined text-lg">add</span>
          <span>New Chat</span>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-4">
        <nav class="flex flex-col gap-2">
          <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-secondary/20 text-secondary dark:text-white dark:bg-secondary/30"
            href="#">
            <span class="material-symbols-outlined text-xl">description</span>
            <span class="text-sm font-medium">Today's Catch Report</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300"
            href="#">
            <span class="material-symbols-outlined text-xl">bar_chart</span>
            <span class="text-sm font-medium">Market Price Inquiry</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300"
            href="#">
            <span class="material-symbols-outlined text-xl">local_shipping</span>
            <span class="text-sm font-medium">Logistics Planning</span>
          </a>
        </nav>
      </div>
    </aside>
    <main class="flex-1 flex flex-col" hx-ext="ws" ws-connect="/ws" ws-swap="afterend" hx-target="#chat-messages">
      <header
        class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 bg-background-light dark:bg-background-dark">
        <div class="flex items-center gap-6">
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="model">Model:</label>
            <select
              class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 shadow-sm focus:border-primary focus:ring-primary focus:ring-opacity-50 sm:text-sm"
              id="model">
              <option>Qwen3-0.6B</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="iterations">Max Iterations:</label>
            <input class="w-24 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
              id="iterations" max="10" min="1" type="range" value="5" name="max_iterations" form="chat-form"
              oninput="document.getElementById('iterations-display').textContent = this.value" />
            <span id="iterations-display" class="text-sm text-gray-700 dark:text-gray-300">5</span>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <label class="flex items-center cursor-pointer" for="reasoning-toggle">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Show Reasoning</span>
            <div class="relative">
              <input class="sr-only toggle-checkbox" id="reasoning-toggle" type="checkbox" name="show_reasoning"
                value="true" form="chat-form" />
              <div class="w-10 h-5 bg-gray-300 dark:bg-gray-600 rounded-full shadow-inner toggle-label">
                <div
                  class="toggle-dot absolute w-4 h-4 bg-white rounded-full shadow inset-y-0.5 left-0.5 transition-transform duration-200 ease-in-out">
                </div>
              </div>
            </div>
          </label>
        </div>
      </header>
      <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6">
        <!-- Chat messages will be swapped here -->
      </div>
      <div id="uploaded-files-container" style="display:none;"></div>
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-background-light dark:bg-background-dark">
        <form id="chat-form" hx-encoding="multipart/form-data" ws-send>
          <div class="flex items-center gap-3">
            <div
              class="flex-1 flex items-center bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 focus-within:border-primary focus-within:ring-1 focus-within:ring-primary">
              <input name="prompt"
                class="form-input w-full min-w-0 flex-1 resize-none overflow-hidden bg-transparent text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-0 border-none h-full placeholder:text-gray-500 dark:placeholder:text-gray-400 px-4 text-base"
                placeholder="Type a message..." required />
              <input type="file" name="files" multiple class="hidden" id="file-upload" hx-post="/upload-file"
                hx-target="#uploaded-files-container" hx-swap="beforeend"
                hx-on::change="htmx.trigger(this, 'change')" />
              <label for="file-upload"
                class="flex items-center justify-center p-2 text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white cursor-pointer">
                <span class="material-symbols-outlined text-xl">attach_file</span>
              </label>
              <div id="upload-progress-bar-container"
                class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 hidden">
                <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
              </div>
              <div id="uploaded-files-list" class="text-xs text-gray-600 dark:text-gray-300 mt-1"></div>

              <button type="submit"
                class="flex items-center justify-center px-4 py-3 rounded-r-lg bg-primary text-white self-stretch -mr-px -my-px">
                <span class="material-symbols-outlined text-xl">send</span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </main>
  </div>
</body>

</html>